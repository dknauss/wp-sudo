# Phase 1 Plan: Integration Test Harness Scaffold

## Overview

Create the integration test infrastructure for WP Sudo so that a real WordPress + MySQL test environment coexists cleanly alongside the existing 220+ Brain\Monkey unit tests. This phase produces only the harness — no tests are written. The phase is complete when `composer test:unit` passes all existing tests unchanged and `composer test:integration` runs an empty suite with zero failures in GitHub Actions CI.

Seven deliverables satisfy seven requirements (HARN-01 through HARN-07): a Composer dependency, a PHPUnit config, a bootstrap file, a base TestCase, an install script, updated Composer scripts, and a CI workflow.

## Prerequisites

- Repository cloned at `/Users/danknauss/Documents/GitHub/wp-sudo`
- `composer install` has been run (vendor directory exists)
- Git working tree is clean (on `main` branch, last commit `312a145`)

## Tasks

### Task 1: Add `yoast/phpunit-polyfills` dependency and create Composer scripts

**Requirements:** HARN-05 (partial — Composer scripts), plus dependency for HARN-01/HARN-03

**Files:**
- `composer.json` (modified)
- `composer.lock` (modified — auto-generated by Composer)

**Description:**

1. Install the polyfills dependency:

```bash
cd /Users/danknauss/Documents/GitHub/wp-sudo
composer require --dev yoast/phpunit-polyfills:"^2.0"
```

This adds `yoast/phpunit-polyfills` to `require-dev` and installs `vendor/yoast/phpunit-polyfills/phpunitpolyfills-autoload.php`, which the WordPress test bootstrap requires.

2. Add the `test:unit` and `test:integration` scripts to `composer.json`. The `scripts` section must become:

```json
"scripts": {
    "lint": "phpcs",
    "lint:fix": "phpcbf",
    "test": "phpunit",
    "test:unit": "phpunit --configuration phpunit.xml.dist",
    "test:integration": "phpunit --configuration phpunit-integration.xml.dist",
    "analyse": "phpstan analyse",
    "sbom": "composer CycloneDX:make-sbom --output-file=bom.json --output-format=JSON --spec-version=1.6 --output-reproducible"
}
```

Critical: `"test": "phpunit"` must remain UNCHANGED. It auto-discovers `phpunit.xml.dist` (the unit config). This preserves backward compatibility with existing `composer test` usage documented in CLAUDE.md.

**Verification:**

```bash
# Confirm polyfills installed
ls vendor/yoast/phpunit-polyfills/phpunitpolyfills-autoload.php

# Confirm scripts are registered
composer run --list | grep test
# Expected output includes: test, test:unit, test:integration

# Confirm composer test still runs unit tests (backward compatible)
composer test
# Expected: 220+ tests, 0 failures — same as before
```

---

### Task 2: Create integration PHPUnit config, bootstrap, and base TestCase

**Requirements:** HARN-01, HARN-02, HARN-03

**Files:**
- `phpunit-integration.xml.dist` (created)
- `tests/integration/bootstrap.php` (created — directory must be created first)
- `tests/integration/TestCase.php` (created)

**Description:**

**2a. Create `phpunit-integration.xml.dist`** in the repository root with this exact content:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<phpunit
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:noNamespaceSchemaLocation="https://schema.phpunit.de/9.6/phpunit.xsd"
    bootstrap="tests/integration/bootstrap.php"
    colors="true"
    beStrictAboutTestsThatDoNotTestAnything="true"
>
    <testsuites>
        <testsuite name="Integration">
            <directory suffix="Test.php">tests/integration</directory>
        </testsuite>
    </testsuites>

    <coverage>
        <include>
            <directory suffix=".php">includes</directory>
        </include>
    </coverage>
</phpunit>
```

Intentionally omitted flags (present in the unit config but NOT here):
- `beStrictAboutOutputDuringTests="true"` — WordPress core emits output during bootstrap (deprecation notices); this flag would fail the entire run before any test executes.
- `failOnWarning="true"` — WordPress and the WP test library emit deprecation warnings during bootstrap.
- `failOnRisky="true"` — Same reason.

**2b. Create `tests/integration/bootstrap.php`** with this exact content:

```php
<?php
/**
 * PHPUnit bootstrap for WP Sudo integration tests.
 *
 * Loads the real WordPress test environment (WP_UnitTestCase, real DB).
 * Brain\Monkey and Patchwork are NOT loaded here — integration tests
 * use real WordPress functions, not mocks.
 *
 * Prerequisites: run `bash bin/install-wp-tests.sh` once before using this suite.
 *
 * @package WP_Sudo\Tests\Integration
 */

$_tests_dir = getenv( 'WP_TESTS_DIR' );

if ( ! $_tests_dir ) {
    $_tests_dir = rtrim( sys_get_temp_dir(), '/\\' ) . '/wordpress-tests-lib';
}

if ( ! file_exists( $_tests_dir . '/includes/functions.php' ) ) {
    echo "ERROR: WordPress test library not found at {$_tests_dir}/includes/functions.php\n";
    echo "Run: bash bin/install-wp-tests.sh wordpress_test root root 127.0.0.1 latest\n";
    exit( 1 );
}

// Polyfills path: tell the WP bootstrap where to find yoast/phpunit-polyfills.
// The WP bootstrap defaults to dirname(__DIR__, 3)/vendor/... which resolves to
// /tmp/vendor/... (wrong). Point it to this plugin's vendor directory instead.
define( 'WP_TESTS_PHPUNIT_POLYFILLS_PATH', dirname( __DIR__, 2 ) . '/vendor/yoast/phpunit-polyfills' );

// Give access to tests_add_filter() before WordPress boots.
require_once $_tests_dir . '/includes/functions.php';

// Load the plugin under test at muplugins_loaded — the earliest safe hook.
// muplugins_loaded fires after WP core functions exist but before plugins_loaded.
// wp-sudo.php calls add_action(), which requires WordPress functions.
tests_add_filter(
    'muplugins_loaded',
    static function () {
        require_once dirname( __DIR__, 2 ) . '/wp-sudo.php';
    }
);

// Composer autoloader for WP_Sudo\Tests\Integration\* classes.
// Do NOT require tests/bootstrap.php — it defines ABSPATH and class stubs
// that conflict with the real WordPress environment loaded below.
require_once dirname( __DIR__, 2 ) . '/vendor/autoload.php';

// Boot the real WordPress environment (connects to MySQL, fires init hooks).
require $_tests_dir . '/includes/bootstrap.php';
```

Critical constraints:
- `WP_TESTS_PHPUNIT_POLYFILLS_PATH` MUST be defined BEFORE `require $_tests_dir . '/includes/bootstrap.php'` (the WP bootstrap reads it on load).
- This file MUST NOT `require` or `require_once` `tests/bootstrap.php` (the unit bootstrap defines `ABSPATH` and class stubs that conflict with real WordPress).
- This file MUST NOT contain any `Brain\Monkey`, `Patchwork`, or `Monkey\setUp()` references.

**2c. Create `tests/integration/TestCase.php`** with this exact content:

```php
<?php
/**
 * Base integration test case for WP Sudo.
 *
 * Extends WP_UnitTestCase for real database + WordPress environment.
 * Each test runs in a database transaction that is rolled back in tear_down().
 *
 * Do NOT use Brain\Monkey here. Do NOT call Monkey\setUp().
 * Integration tests use real WordPress functions, not mocks.
 *
 * @package WP_Sudo\Tests\Integration
 */

namespace WP_Sudo\Tests\Integration;

/**
 * Base class for WP Sudo integration tests.
 */
class TestCase extends \WP_UnitTestCase {

    /**
     * Create an administrator user with a real bcrypt-hashed password in the database.
     *
     * Uses the factory so the created user is auto-cleaned up in tear_down().
     * wp_hash_password() uses cost=5 in test environments (WP_UnitTestCase default).
     *
     * @param string $password Plain-text password for verification tests.
     * @return \WP_User
     */
    protected function make_admin( string $password = 'test-password' ): \WP_User {
        $user_id = self::factory()->user->create(
            array(
                'role'      => 'administrator',
                'user_pass' => $password,
            )
        );
        return get_user_by( 'id', $user_id );
    }

    /**
     * Trigger the plugin's activation hook explicitly.
     *
     * The plugin is loaded via muplugins_loaded in the bootstrap, which does not
     * fire the activation hook. Tests that verify activation side effects
     * (unfiltered_html removal, option creation) must call this method.
     */
    protected function activate_plugin(): void {
        do_action( 'activate_wp-sudo/wp-sudo.php' );
    }
}
```

The namespace `WP_Sudo\Tests\Integration` maps to `tests/integration/` via the existing PSR-4 autoload-dev entry (`"WP_Sudo\\Tests\\"` maps to `"tests/"`). No `composer.json` autoload changes are needed.

**Verification:**

```bash
# Confirm no Brain\Monkey or Patchwork references in integration files
grep -r "Brain\\\Monkey\|Patchwork\|Monkey\\\\setUp" tests/integration/
# Expected: no output

# Confirm bootstrap does NOT require the unit bootstrap
grep "tests/bootstrap.php" tests/integration/bootstrap.php
# Expected: only appears in a "Do NOT require" comment, not as an actual require

# Confirm WP_TESTS_PHPUNIT_POLYFILLS_PATH is defined
grep "WP_TESTS_PHPUNIT_POLYFILLS_PATH" tests/integration/bootstrap.php
# Expected: the define() line

# Confirm TestCase extends WP_UnitTestCase
grep "extends.*WP_UnitTestCase" tests/integration/TestCase.php
# Expected: class TestCase extends \WP_UnitTestCase
```

---

### Task 3: Add `bin/install-wp-tests.sh` from the canonical source

**Requirement:** HARN-04

**Files:**
- `bin/install-wp-tests.sh` (created — `bin/` directory must be created first)

**Description:**

1. Create the `bin/` directory:

```bash
mkdir -p /Users/danknauss/Documents/GitHub/wp-sudo/bin
```

2. Fetch the canonical install script from `wp-cli/scaffold-command`:

```bash
curl -sL https://raw.githubusercontent.com/wp-cli/scaffold-command/main/templates/install-wp-tests.sh -o /Users/danknauss/Documents/GitHub/wp-sudo/bin/install-wp-tests.sh
```

3. Make it executable:

```bash
chmod +x /Users/danknauss/Documents/GitHub/wp-sudo/bin/install-wp-tests.sh
```

Do NOT modify the script. It is a maintained, tested script that handles macOS/Linux differences (Darwin vs Linux `sed -i` syntax), version parsing, SVN availability checks, and both `curl`/`wget` support.

**Usage (for reference — not required to run locally):**

```bash
# CI usage (127.0.0.1 for TCP, not Unix socket):
bash bin/install-wp-tests.sh wordpress_test root root 127.0.0.1 latest

# Local usage (if you have MySQL locally):
bash bin/install-wp-tests.sh wordpress_test root '' localhost latest
```

Argument order: `$1=DB_NAME`, `$2=DB_USER`, `$3=DB_PASS`, `$4=DB_HOST`, `$5=WP_VERSION`.

**Verification:**

```bash
# Confirm file exists and is executable
ls -la bin/install-wp-tests.sh
# Expected: -rwxr-xr-x (executable)

# Confirm it's the real script (has the expected functions)
grep -c "install_wp\|install_test_suite\|install_db\|check_svn_installed" bin/install-wp-tests.sh
# Expected: 4 or more matches

# Confirm it's not empty or truncated
wc -l bin/install-wp-tests.sh
# Expected: 100+ lines
```

---

### Task 4: Create GitHub Actions CI workflow

**Requirement:** HARN-06

**Files:**
- `.github/workflows/phpunit.yml` (created)

**Description:**

Create `.github/workflows/phpunit.yml` with this exact content:

```yaml
name: PHPUnit

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  unit-tests:
    name: "Unit Tests (PHP ${{ matrix.php }})"
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        php: ['8.1', '8.2', '8.3', '8.4']
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          tools: composer:v2
          coverage: none

      - name: Install Composer dependencies
        run: composer install --no-interaction --prefer-dist

      - name: Run unit tests
        run: composer test:unit

  integration-tests:
    name: "Integration Tests (PHP ${{ matrix.php }}, WP ${{ matrix.wp }})"
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        php: ['8.1', '8.3']
        wp: ['latest', 'trunk']
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: wordpress_test
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    env:
      WP_TESTS_DIR: /tmp/wordpress-tests-lib
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          tools: composer:v2, svn
          extensions: mysqli
          coverage: none

      - name: Install Composer dependencies
        run: composer install --no-interaction --prefer-dist

      - name: Install WordPress test suite
        run: bash bin/install-wp-tests.sh wordpress_test root root 127.0.0.1 ${{ matrix.wp }}

      - name: Run integration tests
        run: composer test:integration
```

Key design decisions:
- `ubuntu-24.04` (explicit LTS, not `ubuntu-latest`) to avoid unexpected runner changes.
- `fail-fast: false` on both matrices so one PHP version failure does not cancel others.
- Unit tests: PHP 8.1, 8.2, 8.3, 8.4 (all supported versions). No MySQL needed.
- Integration tests: PHP 8.1 + 8.3 only (subset — integration tests are slower). WP `latest` + `trunk` (trunk covers WP 7.0 nightly).
- `mysql:8.0` service container with health checks — ensures MySQL is ready before steps run.
- `127.0.0.1` in the `install-wp-tests.sh` call, NOT `localhost` — forces TCP connection. `localhost` causes a Unix socket attempt that fails in GitHub Actions service containers.
- `tools: composer:v2, svn` — SVN is required by `install-wp-tests.sh` to export the WP test suite.
- `extensions: mysqli` — required for WordPress database connections in the test environment.
- `WP_TESTS_DIR: /tmp/wordpress-tests-lib` — matches the default used by `install-wp-tests.sh`.

**Verification:**

```bash
# Confirm the workflow file exists
ls .github/workflows/phpunit.yml

# Confirm it uses 127.0.0.1 not localhost for MySQL
grep "127.0.0.1" .github/workflows/phpunit.yml
# Expected: the install-wp-tests.sh line

# Confirm it does NOT use localhost for MySQL
grep "localhost" .github/workflows/phpunit.yml
# Expected: no output

# Confirm MySQL 8.0 service is defined
grep "mysql:8.0" .github/workflows/phpunit.yml
# Expected: one match

# Confirm both composer test:unit and test:integration are called
grep "composer test:" .github/workflows/phpunit.yml
# Expected: test:unit and test:integration
```

---

### Task 5: Verify unit test regression (HARN-07) and validate full harness

**Requirement:** HARN-07 (plus overall validation of HARN-01 through HARN-06)

**Files:** None (verification only)

**Description:**

Run the existing unit tests to confirm zero regressions after all Phase 1 changes:

```bash
composer test:unit
```

Expected: all ~220 existing tests pass, 0 failures, 0 errors. The test count and results must match the pre-Phase-1 baseline exactly.

Also confirm backward compatibility:

```bash
composer test
```

Expected: identical results to `composer test:unit` (PHPUnit auto-discovers `phpunit.xml.dist`, which is the unit config).

Then validate the full harness by inspection:

1. **No Brain\Monkey contamination in integration files:**
```bash
grep -r "Brain\\\Monkey\|Patchwork\|Monkey\\\\setUp\|MockeryPHPUnitIntegration" tests/integration/
# Expected: no output
```

2. **Composer scripts are registered correctly:**
```bash
composer run --list | grep test
# Expected: test, test:unit, test:integration
```

3. **Integration config references correct bootstrap:**
```bash
grep 'bootstrap=' phpunit-integration.xml.dist
# Expected: bootstrap="tests/integration/bootstrap.php"
```

4. **Integration config does NOT reference unit test directory:**
```bash
grep "tests/Unit" phpunit-integration.xml.dist
# Expected: no output
```

5. **Install script is executable:**
```bash
test -x bin/install-wp-tests.sh && echo "executable" || echo "NOT executable"
# Expected: executable
```

Do NOT attempt to run `composer test:integration` locally — it requires a MySQL database and the WordPress test library installed via `bin/install-wp-tests.sh`. CI verification (Task 4's workflow) handles this.

**Verification:**

All of the above commands produce expected results. The phase is complete when:
- `composer test:unit` passes (~220 tests, 0 failures)
- `composer test` produces identical results (backward compatible)
- No Brain\Monkey or Patchwork references exist in `tests/integration/`
- All 7 files exist: `composer.json` (updated), `composer.lock` (updated), `phpunit-integration.xml.dist`, `tests/integration/bootstrap.php`, `tests/integration/TestCase.php`, `bin/install-wp-tests.sh`, `.github/workflows/phpunit.yml`
- CI workflow will run both unit and integration jobs when pushed (verified by pushing to a branch or opening a PR)
