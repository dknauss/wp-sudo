{\rtf1\ansi\ansicpg1252\cocoartf2868
\cocoatextscaling0\cocoaplatform0{\fonttbl\f0\fnil\fcharset0 .AppleSystemUIFontMonospaced-Regular;}
{\colortbl;\red255\green255\blue255;\red16\green16\blue16;\red205\green231\blue208;\red205\green231\blue208;
}
{\*\expandedcolortbl;;\cssrgb\c7843\c7843\c7451;\cssrgb\c83922\c92157\c85098\c90196;\cssrgb\c83922\c92157\c85098\c45098;
}
\margl1440\margr1440\vieww11520\viewh8400\viewkind0
\deftab720
\pard\pardeftab720\partightenfactor0

\f0\fs18 \cf2 \cb3 \expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 # Improve Test Coverage Infrastructure\cb1 \
\pard\pardeftab720\partightenfactor0
\cf2 \cb4 \'a0\cb1 \
\cb4 ## Context\cb1 \
\cb4 \'a0\cb1 \
\cb4 WP Sudo has 489 tests (397 unit + 92 integration) with all 10 production classes covered, but no actual code coverage measurement exists. The `phpunit.xml.dist` files declare `<coverage><include>` blocks for `includes/`, but no coverage driver is configured \'97 CI runs with `coverage: none`. The "90%+" figure in the external review was fabricated. We need to measure before we can improve.\cb1 \
\cb4 \'a0\cb1 \
\cb4 Beyond measurement, three specific gaps carry real risk:\cb1 \
\cb4 1. **Challenge class** \'97 has unit tests only; the most security-critical flow (password verification \uc0\u8594  session grant \u8594  stash replay) has no integration test\cb1 \
\cb4 2. **`uninstall.php`** \'97 has zero tests; cleans up roles, options, and user meta across multisite networks\cb1 \
\cb4 3. **Coverage reporting** \'97 no baseline, no regression prevention\cb1 \
\cb4 \'a0\cb1 \
\cb4 ## Plan\cb1 \
\cb4 \'a0\cb1 \
\cb4 ### Step 1: Add PCOV coverage to CI (one matrix entry only)\cb1 \
\cb4 \'a0\cb1 \
\cb4 **Files:** `.github/workflows/phpunit.yml`, `composer.json`\cb1 \
\cb4 \'a0\cb1 \
\cb4 In the unit-tests job, add a dedicated coverage step for PHP 8.3 only (coverage is deterministic across PHP versions \'97 running it on all 4 would waste CI minutes):\cb1 \
\cb4 \'a0\cb1 \
\cb4 - Add a new job `unit-tests-coverage` that runs after unit-tests, PHP 8.3 only\cb1 \
\cb4 - Use `shivammathur/setup-php` with `coverage: pcov` (not xdebug \'97 PCOV is ~10x faster)\cb1 \
\cb4 - Run: `./vendor/bin/phpunit --configuration phpunit.xml.dist --coverage-clover coverage.xml --coverage-text`\cb1 \
\cb4 - Upload `coverage.xml` as an artifact for inspection\cb1 \
\cb4 - **Do not** set a failure threshold yet \'97 first run establishes the baseline\cb1 \
\cb4 \'a0\cb1 \
\cb4 Add a composer script for local use:\cb1 \
\cb4 ```json\cb1 \
\cb4 "test:coverage": "phpunit --configuration phpunit.xml.dist --coverage-clover coverage.xml --coverage-text"\cb1 \
\cb4 ```\cb1 \
\cb4 \'a0\cb1 \
\cb4 **Note:** PCOV is a PHP extension installed by `shivammathur/setup-php`, not a Composer dependency. No change to `composer.json` dependencies. Only the scripts section gets the convenience alias.\cb1 \
\cb4 \'a0\cb1 \
\cb4 ### Step 2: Add Challenge integration test\cb1 \
\cb4 \'a0\cb1 \
\cb4 **File:** `tests/Integration/ChallengeTest.php`\cb1 \
\cb4 \'a0\cb1 \
\cb4 Write TDD-style (failing test first). This test exercises the security-critical path that currently has unit tests only:\cb1 \
\cb4 \'a0\cb1 \
\cb4 1. **Setup:** Create admin user with known password via `make_admin()`\cb1 \
\cb4 2. **Gated request:** Simulate plugin activation \uc0\u8594  `Gate::match_request()` returns rule\cb1 \
\cb4 3. **Stash:** `Request_Stash::save()` \'97 verify transient created\cb1 \
\cb4 4. **Wrong password:** `Sudo_Session::attempt_activation($user_id, 'wrong')` \'97 verify returns `'invalid_password'`, session NOT active, `wp_sudo_reauth_failed` hook fires\cb1 \
\cb4 5. **Correct password:** `Sudo_Session::attempt_activation($user_id, $password)` \'97 verify returns `'success'`, session IS active, `wp_sudo_activated` hook fires\cb1 \
\cb4 6. **Token binding:** Verify `$_COOKIE[TOKEN_COOKIE]` exists, `hash('sha256', cookie) === stored meta`\cb1 \
\cb4 7. **Stash replay:** `Request_Stash::get($key, $user_id)` \'97 verify returns original request data, then `delete()` \'97 verify gone\cb1 \
\cb4 \'a0\cb1 \
\cb4 This mirrors the `ReauthFlowTest` pattern but focuses on Challenge-adjacent verification (wrong password path, hook firing, token chain) rather than the 5-class contract.\cb1 \
\cb4 \'a0\cb1 \
\cb4 ### Step 3: Add uninstall integration test\cb1 \
\cb4 \'a0\cb1 \
\cb4 **File:** `tests/Integration/UninstallTest.php`\cb1 \
\cb4 \'a0\cb1 \
\cb4 Two test methods:\cb1 \
\cb4 \'a0\cb1 \
\cb4 **`test_single_site_uninstall_cleans_all_data()`:**\cb1 \
\cb4 1. Activate plugin (fires activation hook \uc0\u8594  removes `unfiltered_html` from editors)\cb1 \
\cb4 2. Create admin user, activate sudo session (creates `_wp_sudo_*` user meta)\cb1 \
\cb4 3. Verify meta and options exist\cb1 \
\cb4 4. Require `uninstall.php` with `WP_UNINSTALL_PLUGIN` defined\cb1 \
\cb4 5. Assert: `wp_sudo_settings` option deleted, `_wp_sudo_expires` meta deleted, `_wp_sudo_token` meta deleted, `_wp_sudo_failed_attempts` meta deleted, `_wp_sudo_lockout_until` meta deleted, `site_manager` role removed, editor `unfiltered_html` restored\cb1 \
\cb4 \'a0\cb1 \
\cb4 **`test_multisite_uninstall_preserves_active_site_data()`** (only runs when `WP_MULTISITE`):\cb1 \
\cb4 1. Create 2 subsites via factory\cb1 \
\cb4 2. On site A: activate plugin, create sudo session\cb1 \
\cb4 3. On site B: do NOT activate (plugin not in `active_plugins`)\cb1 \
\cb4 4. Run uninstall from site B context\cb1 \
\cb4 5. Assert: site B options cleaned, site A options preserved, user meta preserved (because site A still active)\cb1 \
\cb4 \'a0\cb1 \
\cb4 **Note:** The uninstall file uses `is_multisite()`, `get_sites()`, `switch_to_blog()` \'97 all real in the integration environment. The multisite test runs only in the `WP_MULTISITE=1` CI matrix entries.\cb1 \
\cb4 \'a0\cb1 \
\cb4 ### Step 4: Update CLAUDE.md and ROADMAP.md\cb1 \
\cb4 \'a0\cb1 \
\cb4 Add the coverage command to the verification commands section:\cb1 \
\cb4 ```bash\cb1 \
\cb4 # Code coverage (requires PCOV extension)\cb1 \
\cb4 composer test:coverage   # Generates coverage.xml + terminal summary\cb1 \
\cb4 ```\cb1 \
\cb4 \'a0\cb1 \
\cb4 Note in ROADMAP.md that coverage measurement is now available and the baseline should be recorded after the first CI run.\cb1 \
\cb4 \'a0\cb1 \
\cb4 ### Step 5: Commit and sync\cb1 \
\cb4 \'a0\cb1 \
\cb4 - Commit: `test: add PCOV coverage CI job, Challenge and uninstall integration tests`\cb1 \
\cb4 - Follow TDD: write failing tests first, then verify they pass against real code\cb1 \
\cb4 - Push, sync to all 5 dev sites\cb1 \
\cb4 - **No version bump** \'97 test infrastructure changes don't warrant a release\cb1 \
\cb4 \'a0\cb1 \
\cb4 ## Files Modified\cb1 \
\cb4 \'a0\cb1 \
\cb4 - `.github/workflows/phpunit.yml` \'97 new `unit-tests-coverage` job\cb1 \
\cb4 - `composer.json` \'97 new `test:coverage` script alias\cb1 \
\cb4 - `tests/Integration/ChallengeTest.php` \'97 new file\cb1 \
\cb4 - `tests/Integration/UninstallTest.php` \'97 new file\cb1 \
\cb4 - `CLAUDE.md` \'97 coverage command in verification section\cb1 \
\cb4 - `ROADMAP.md` \'97 note coverage baseline\cb1 \
\cb4 \'a0\cb1 \
\cb4 ## Files Referenced (read-only)\cb1 \
\cb4 \'a0\cb1 \
\cb4 - `phpunit.xml.dist` \'97 already has `<coverage><include>` for `includes/`\cb1 \
\cb4 - `phpunit-integration.xml.dist` \'97 same\cb1 \
\cb4 - `tests/Integration/TestCase.php` \'97 base class with `make_admin()`, `simulate_admin_request()`, `activate_plugin()`\cb1 \
\cb4 - `tests/Integration/ReauthFlowTest.php` \'97 pattern to follow for Challenge test\cb1 \
\cb4 - `uninstall.php` \'97 the code under test for UninstallTest\cb1 \
\cb4 - `includes/class-sudo-session.php` \'97 `attempt_activation()`, `is_active()`, `TOKEN_COOKIE`, `TOKEN_META_KEY`\cb1 \
\cb4 - `includes/class-request-stash.php` \'97 `save()`, `get()`, `delete()`, `exists()`\cb1 \
\cb4 \'a0\cb1 \
\cb4 ## Verification\cb1 \
\cb4 \'a0\cb1 \
\cb4 1. `composer test:unit` \'97 existing 397 tests still pass\cb1 \
\cb4 2. `composer test:integration` \'97 existing 92 + new tests pass (locally, requires MySQL)\cb1 \
\cb4 3. `composer test:coverage` \'97 generates `coverage.xml`, terminal output shows line coverage % (requires PCOV locally; CI will run this)\cb1 \
\cb4 4. `composer analyse -- --memory-limit=1G` \'97 PHPStan clean\cb1 \
\cb4 5. `composer lint` \'97 PHPCS clean\cb1 \
}