name: Playground Preview

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  pull-requests: write

jobs:
  playground-preview:
    name: "Post Playground preview link"
    runs-on: ubuntu-24.04
    steps:
      - name: Post Playground preview comment
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const sha = pr.head.sha;

            // GitHub archive zips have a top-level dir named `wp-sudo-{sha}/`.
            // WordPress identifies plugins by the Plugin Name header, not the
            // directory name, so activation still works correctly.
            const zipUrl =
              `https://github.com/${context.repo.owner}/${context.repo.repo}/archive/${sha}.zip`;

            const blueprint = {
              '$schema': 'https://playground.wordpress.net/blueprint-schema.json',
              landingPage: '/wp-admin/',
              steps: [
                { step: 'login', username: 'admin', password: 'password' },
                {
                  step: 'installPlugin',
                  pluginZipFile: { resource: 'url', url: zipUrl },
                  options: { activate: true },
                },
              ],
            };

            const encoded = encodeURIComponent(JSON.stringify(blueprint));
            const playgroundUrl = `https://playground.wordpress.net/#${encoded}`;

            const body = [
              '## ðŸŽ® Try in WordPress Playground',
              '',
              `[**Open this PR in Playground â†’**](${playgroundUrl})`,
              '',
              'Logs in as `admin` / `password` and installs the plugin from this PR\'s commit.',
              '',
              '### âœ… What you can test',
              '',
              '| Feature | Notes |',
              '|---|---|',
              '| Plugin activation & settings page | âœ… |',
              '| Gate fires on dangerous actions (plugin activate/delete, user delete, etc.) | âœ… |',
              '| Challenge / reauthentication page | âœ… |',
              '| Password verification & session cookie | âœ… |',
              '| Admin bar countdown timer | âœ… |',
              '| Request stash & replay after auth | âœ… |',
              '| Rate limiting / 5-attempt lockout | âœ… within session |',
              '| Session expiry by time | âœ… wait out the configured duration (1â€“15 min) |',
              '| `unfiltered_html` removed from Editor role | âœ… |',
              '',
              '### âŒ What won\'t work',
              '',
              '| Feature | Why |',
              '|---|---|',
              '| WP-CLI / Cron entry point policies | No CLI in browser |',
              '| REST / XML-RPC entry point policies | Network disabled in Playground |',
              '| Two Factor plugin integration | Can\'t install from .org (network off) |',
              '| Multisite behaviour | Single-site only |',
              '| State after refreshing Playground | Full reset on page reload |',
              '',
              '> Transients and user meta persist across normal WP navigation within',
              '> a session, but are wiped if you reload the Playground page itself.',
              '> Use the [integration test suite](tests/Integration/) to verify',
              '> transient TTL, real bcrypt, and multisite isolation.',
            ].join('\n');

            // Update existing bot comment if present, otherwise create one.
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
            });

            const existing = comments.find(
              c =>
                c.user.login === 'github-actions[bot]' &&
                c.body.includes('Try in WordPress Playground'),
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body,
              });
            }
